<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="ArmTorpedos">
        <Sequence>
            <Action ID="Info" message="Arming Torpedos..."/>
            <Fallback>
                <Decorator ID="RetryUntilSuccessfulOrTimeout" num_seconds="5">
                    <Sequence>
                        <Action ID="ActuateState" arm_torpedo="1" clear_dropper_status="" close_claw="" disarm_torpedo="" drop_1="" drop_2="" fire_torpedo_1="" fire_torpedo_2="" open_claw="" reset_actuators=""/>
                        <Action ID="WaitState" seconds="1"/>
                        <SubTree ID="GetActuatorStates" __shared_blackboard="true"/>
                        <Inverter>
                            <Condition ID="IsTorpedoDisarmed" torpedo_state="{torpedo1_state}"/>
                        </Inverter>
                        <Inverter>
                            <Condition ID="IsTorpedoDisarmed" torpedo_state="{torpedo2_state}"/>
                        </Inverter>
                    </Sequence>
                </Decorator>
                <ForceFailure>
                    <Action ID="Error" message="Failed to arm torpedos!"/>
                </ForceFailure>
            </Fallback>
            <Action ID="Info" message="Torpedos Armed."/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <SetBlackboard output_key="id" value="1"/>
            <SubTree ID="FireTorpedo" __shared_blackboard="false" torpedo_id="id"/>
            <Action ID="Info" message="Tree done."/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="DisarmTorpedos">
        <Fallback>
            <Decorator ID="RetryUntilSuccessfulOrTimeout" num_seconds="5">
                <Sequence>
                    <Action ID="ActuateState" arm_torpedo="" clear_dropper_status="" close_claw="" disarm_torpedo="1" drop_1="" drop_2="" fire_torpedo_1="" fire_torpedo_2="" open_claw="" reset_actuators=""/>
                    <SubTree ID="GetActuatorStates" __shared_blackboard="true"/>
                    <Fallback>
                        <Condition ID="IsTorpedoDisarmed" torpedo_state="{torpedo1}"/>
                        <Condition ID="IsTorpedoError" torpedo_state="{torpedo1}"/>
                    </Fallback>
                    <Fallback>
                        <Condition ID="IsTorpedoDisarmed" torpedo_state="{torpedo2}"/>
                        <Condition ID="IsTorpedoError" torpedo_state="{torpedo2}"/>
                    </Fallback>
                </Sequence>
            </Decorator>
            <ForceFailure>
                <Action ID="Error" message="Failed to disarm torpedos!"/>
            </ForceFailure>
        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="FireTorpedo">
        <Fallback>
            <Sequence>
                <Action ID="Info" message="Attempting to fire torpedo {torpedo_id}"/>
                <SubTree ID="WaitForTorpedoCharged" __shared_blackboard="false" torpedo_id="torpedo_id"/>
                <Decorator ID="RetryUntilSuccessfulOrTimeout" num_seconds="10">
                    <Sequence name="Attempt to fire torpedo">
                        <SetBlackboard name="Set &quot;1&quot;" output_key="1" value="1"/>
                        <IfThenElse name="Select Torpedo">
                            <Condition ID="NumsEqual" a="1" b="{torpedo_id}"/>
                            <Action ID="ActuateState" arm_torpedo="" clear_dropper_status="" close_claw="" disarm_torpedo="" drop_1="" drop_2="" fire_torpedo_1="1" fire_torpedo_2="" open_claw="" reset_actuators=""/>
                            <Action ID="ActuateState" arm_torpedo="" clear_dropper_status="" close_claw="" disarm_torpedo="" drop_1="" drop_2="" fire_torpedo_1="" fire_torpedo_2="1" open_claw="" reset_actuators=""/>
                        </IfThenElse>
                        <Action ID="WaitState" seconds="1"/>
                        <SubTree ID="GetTorpedoState" __shared_blackboard="false" torpedo_id="torpedo_id" torpedo_state="torpedo_state"/>
                        <Fallback>
                            <Condition ID="IsTorpedoFired" torpedo_state="{torpedo_state}"/>
                            <Sequence>
                                <Condition ID="IsTorpedoError" torpedo_state="{torpedo_state}"/>
                                <ForceFailure>
                                    <Action ID="Error" message="Torpedo {torpedo_id} is in an error state!"/>
                                </ForceFailure>
                            </Sequence>
                        </Fallback>
                    </Sequence>
                </Decorator>
                <Action ID="Info" message="Successfully fired torpedo {torpedo_id}"/>
            </Sequence>
            <ForceFailure>
                <Action ID="Error" message="Failed to fire torpedo {torpedo_id}!"/>
            </ForceFailure>
        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="GetActuatorStates">
        <Fallback>
            <Decorator ID="RetryUntilSuccessfulOrTimeout" num_seconds="7">
                <Sequence>
                    <Action ID="GetActuatorStatus" claw_state="{claw_state}" dropper1_state="{dropper1_state}" dropper2_state="{dropper2_state}" torpedo1_state="{torpedo1_state}" torpedo2_state="{torpedo2_state}"/>
                </Sequence>
            </Decorator>
            <ForceFailure>
                <Action ID="Error" message="Failed to get actuator states!"/>
            </ForceFailure>
        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="GetTorpedoState">
        <Sequence>
            <SubTree ID="GetActuatorStates" __shared_blackboard="true"/>
            <IfThenElse name="Choose appropriate torpedo">
                <Condition ID="NumsEqual" a="1" b="{torpedo_id}"/>
                <SetBlackboard name="choose torpedo 1" output_key="torpedo_state" value="{torpedo1_state}"/>
                <SetBlackboard name="choose torpedo 2" output_key="torpedo_state" value="{torpedo2_state}"/>
            </IfThenElse>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="WaitForTorpedoCharged">
        <Sequence>
            <Action ID="Info" message="Waiting for torpedo {torpedo_id} to charge."/>
            <SetBlackboard name="Set &quot;1&quot;" output_key="1" value="1"/>
            <Decorator ID="RetryUntilSuccessfulOrTimeout" name="Wait until charged or error" num_seconds="30">
                <Sequence>
                    <Action ID="WaitState" seconds="1"/>
                    <SubTree ID="GetTorpedoState" __shared_blackboard="false" torpedo_id="torpedo_id" torpedo_state="torpedo_state"/>
                    <Fallback name="assess state">
                        <Condition ID="IsTorpedoCharged" torpedo_state="{torpedo_state}"/>
                        <Condition ID="IsTorpedoError" torpedo_state="{torpedo_state}"/>
                    </Fallback>
                </Sequence>
            </Decorator>
            <SubTree ID="GetTorpedoState" __shared_blackboard="false" torpedo_id="torpedo_id" torpedo_state="torpedo_state"/>
            <Fallback>
                <Condition ID="IsTorpedoCharged" torpedo_state="{torpedo_state}"/>
                <ForceFailure>
                    <Action ID="Error" message="Torpedo {torpedo_id} failed to charge!"/>
                </ForceFailure>
            </Fallback>
            <Action ID="Info" message="Torpedo {torpedo_id} charged."/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Action ID="ActuateState">
            <input_port name="arm_torpedo"/>
            <input_port name="clear_dropper_status"/>
            <input_port name="close_claw"/>
            <input_port name="disarm_torpedo"/>
            <input_port name="drop_1"/>
            <input_port name="drop_2"/>
            <input_port name="fire_torpedo_1"/>
            <input_port name="fire_torpedo_2"/>
            <input_port name="open_claw"/>
            <input_port name="reset_actuators"/>
        </Action>
        <SubTree ID="ArmTorpedos"/>
        <Action ID="BigMoveState">
            <input_port default="1" name="orientation_w">optional</input_port>
            <input_port default="0" name="orientation_x">optional</input_port>
            <input_port default="0" name="orientation_y">optional</input_port>
            <input_port default="0" name="orientation_z">optional</input_port>
            <input_port name="v_pitch">optional</input_port>
            <input_port name="v_roll">optional</input_port>
            <input_port name="v_yaw">optional</input_port>
            <input_port default="0" name="x">optional</input_port>
            <input_port default="0" name="y">optional</input_port>
            <input_port default="-1" name="z">optional</input_port>
        </Action>
        <SubTree ID="DisarmTorpedos"/>
        <Action ID="Error">
            <input_port name="message">The message to print.</input_port>
        </Action>
        <SubTree ID="FireTorpedo">
            <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port name="torpedo_id"/>
        </SubTree>
        <Action ID="FlattenCalculationState">
            <input_port default="-1" name="depth">Depth the robot sinks to. Required</input_port>
            <output_port default="1" name="orientation_w"/>
            <output_port default="0" name="orientation_x"/>
            <output_port default="0" name="orientation_y"/>
            <output_port default="0" name="orientation_z"/>
            <output_port default="0" name="x"/>
            <output_port default="0" name="y"/>
            <output_port default="-1" name="z"/>
        </Action>
        <SubTree ID="GetActuatorStates">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
        </SubTree>
        <Action ID="GetActuatorStatus">
            <output_port name="claw_state"/>
            <output_port name="dropper1_state"/>
            <output_port name="dropper2_state"/>
            <output_port name="torpedo1_state"/>
            <output_port name="torpedo2_state"/>
        </Action>
        <SubTree ID="GetTorpedoState">
            <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port name="torpedo_id"/>
            <output_port name="torpedo_state"/>
        </SubTree>
        <Action ID="Info">
            <input_port name="message">The message to print.</input_port>
        </Action>
        <Condition ID="IsClawClosed">
            <input_port name="claw_state"/>
        </Condition>
        <Condition ID="IsClawError">
            <input_port name="claw_state"/>
        </Condition>
        <Condition ID="IsClawOpen">
            <input_port name="claw_state"/>
        </Condition>
        <Condition ID="IsClawUnknown">
            <input_port name="claw_state"/>
        </Condition>
        <Condition ID="IsDropperDropped">
            <input_port name="dropper_state"/>
        </Condition>
        <Condition ID="IsDropperError">
            <input_port name="dropper_state"/>
        </Condition>
        <Condition ID="IsDropperReady">
            <input_port name="dropper_state"/>
        </Condition>
        <Condition ID="IsTorpedoCharged">
            <input_port name="torpedo_state"/>
        </Condition>
        <Condition ID="IsTorpedoCharging">
            <input_port name="torpedo_state"/>
        </Condition>
        <Condition ID="IsTorpedoDisarmed">
            <input_port name="torpedo_state"/>
        </Condition>
        <Condition ID="IsTorpedoError">
            <input_port name="torpedo_state"/>
        </Condition>
        <Condition ID="IsTorpedoFired">
            <input_port name="torpedo_state"/>
        </Condition>
        <Condition ID="NumsEqual">
            <input_port name="a"/>
            <input_port name="b"/>
        </Condition>
        <Decorator ID="RetryUntilSuccessfulOrTimeout">
            <input_port name="num_seconds">number of seconds until abandonment.</input_port>
        </Decorator>
        <Action ID="SearchState">
            <input_port name="frame">The frame to search for</input_port>
            <input_port name="target_error">The goal amount of error for the state to succeed.</input_port>
            <input_port name="update_sec">How much time to wait for update</input_port>
        </Action>
        <Action ID="ShootTorpedoState"/>
        <Action ID="ToString">
            <input_port name="double_in">optional. use if value is a double</input_port>
            <input_port name="int_in">optional. use if value is a string</input_port>
            <output_port name="str_out">output.</output_port>
        </Action>
        <Action ID="ToWorldFrameState">
            <input_port name="object">Object to calculate relative to. Required.</input_port>
            <input_port name="relative_orientation_w">Orienation is relative to object. Required.</input_port>
            <input_port name="relative_orientation_x">Required</input_port>
            <input_port name="relative_orientation_y">Required</input_port>
            <input_port name="relative_orientation_z">Required</input_port>
            <input_port name="relative_x">Position is also relative to object. Required.</input_port>
            <input_port name="relative_y">Required</input_port>
            <input_port name="relative_z">Required</input_port>
            <output_port name="world_orientation_w"/>
            <output_port name="world_orientation_x"/>
            <output_port name="world_orientation_y"/>
            <output_port name="world_orientation_z"/>
            <output_port name="world_x"/>
            <output_port name="world_y"/>
            <output_port name="world_z"/>
        </Action>
        <Action ID="VelocityState">
            <input_port default="1" name="time">Time to drive for. Required</input_port>
            <input_port default="1" name="x_velocity">Required</input_port>
            <input_port default="0" name="y_velocity">Required</input_port>
            <input_port default="0" name="z_velocity">Required</input_port>
        </Action>
        <SubTree ID="WaitForTorpedoCharged">
            <input_port default="false" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port name="torpedo_id"/>
        </SubTree>
        <Action ID="WaitState">
            <input_port name="seconds">number of seconds to wait.</input_port>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>

